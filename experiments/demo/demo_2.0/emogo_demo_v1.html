<!DOCTYPE html>
<html>

<head>

  <script src="jsPsych-6.3.1/examples/js/snap.svg-min.js"></script>
  <script src="jsPsych-6.3.1/jspsych.js"></script>
  <script src="jspsych-explore-choice.js"></script>
  <script src="jspsych-show-reward.js"></script>
  <script src="jsPsych-6.3.1/plugins/jspsych-instructions.js"></script>
  <script src="jsPsych-6.3.1/plugins/jspsych-preload.js"></script>
  <script src="jsPsych-6.3.1/plugins/jspsych-survey-text.js"></script>
  <script src="jsPsych-6.3.1/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="jsPsych-6.3.1/plugins/jspsych-survey-multi-select.js"></script>
  <script src="jsPsych-6.3.1/plugins/jspsych-html-slider-response.js"></script>
  <link rel="stylesheet" href="jsPsych-6.3.1/css/jspsych.css">
</head>
<body></body>
<script>

  //define permutation functions
  const rotations = ([l, ...ls], rs = []) => 
  l == undefined ? [] : [[l, ...ls, ...rs], ... rotations (ls, [...rs, l])]

const permutations = ([l, ...ls]) =>
  l == undefined ? [[]] : [...permutations (ls) .flatMap (p => rotations ([l, ...p])) ]


// function for generating a normal distribution between [0,1]
// source: https://stackoverflow.com/questions/25582882/javascript-math-random-normal-distribution-gaussian-bell-curve/36481059#36481059
  function randn_bm() {
  let u = 0, v = 0;
  while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
  while(v === 0) v = Math.random();
  let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
  num = num / 10.0 + 0.5; // Translate to 0 -> 1
  if (num > 1 || num < 0) return randn_bm() // resample between 0 and 1
  return num
}

// function for generating reward (with noise)
function compute_reward(reward,noise_type,reward_adj_factor,reward_adj_shift) {
  //compute reward noise
  if (noise_type == "normal") {
    reward_noise = Math.floor(randn_bm()*reward_adj_factor)-reward_adj_shift;
  } else if (noise_type == "uniform") {
    reward_noise = Math.floor(Math.random()*reward_adj_factor)-reward_adj_shift;
  } else {
    reward_noise = 0;
  }
  updated_reward = reward + reward_noise
  return updated_reward
}

//general function for grabbing parameter from a URL
function getParamFromURL( name ) {
  name = name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");
  var regexS = "[\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return "";
  else
    return results[1];
}

  // get participant-specific url parameters from Prolific study link
  var prolific_pid = getParamFromURL('PROLIFIC_PID');
  var study_id = getParamFromURL('STUDY_ID');
  var session_id = getParamFromURL('SESSION_ID');

  //make sure that nobody can enter anything damaging
  prolific_pid.replace(/[^A-Za-z0-9_]/g, "");
  study_id.replace(/[^A-Za-z0-9_]/g, "");
  session_id.replace(/[^A-Za-z0-9_]/g, "");

  console.log(prolific_pid);
  console.log(study_id);
  console.log(session_id);

  var prolific_code = "XXX"

  var timeline=[];

  //create conditions based on url parameters
  var structure_conditions = ["emotion","model"];
  var match_conditions = ["match","mismatch"];
  //var structure_condition = jsPsych.randomization.sampleWithoutReplacement(structure_conditions)[0];
  //var match_condition = jsPsych.randomization.sampleWithoutReplacement(match_conditions)[0];

  var structure_temp = getParamFromURL('struc');
  var match_temp = getParamFromURL('mat');
  if (structure_temp=="e") {
    var structure_condition = "emotion"
  } else if (structure_temp=="m") {
    var structure_condition = "model"
  } else {
    var structure_condition = jsPsych.randomization.sampleWithoutReplacement(structure_conditions)[0];
  }
  if (match_temp=="ma") {
    var match_condition = "match"
  } else if (match_temp=="mi") {
    var match_condition = "mismatch"
  } else {
    var match_condition = jsPsych.randomization.sampleWithoutReplacement(match_conditions)[0];
  }

  //create reward parameters
  var rewards = [2,4,6,8];
  var reward_depiction_factor = 0.5;
  var reward_adj_factor = 5;
  var reward_adj_shift = 2;
  var noise_type = "uniform";

  // record information in the jsPsych data
  // this adds a property called 'subject', a property called workerId, and a condition property
  jsPsych.data.addProperties({
    prolific_id: prolific_pid,
    study: study_id,
    session: session_id,
    structure_condition: structure_condition,
    match_condition: match_condition,
    noise_type: noise_type
  });


  var reward_index = [0,1,2,3];
  reward_index_1 = jsPsych.randomization.shuffle(reward_index);
  reward_index_2 = jsPsych.randomization.shuffle(reward_index);

  var models = ["AF02", "AF09", "AF10", "AF11","AM03","AM05","AM06","AM09","BF04","BF05","BF06","BF08","BM03", "BM04", "BM07", "BM16","HF02", "HF04", "HF09", "HF10","HM02", "HM07", "HM09", "HM10","WF04", "WF06", "WF11", "WF14","WM07", "WM09", "WM11", "WM13"];
  var emotions = ["AO","CC","DO","FO","HE","HO","SC","SUR"];

  var num_options = 4

  var models_1 = jsPsych.randomization.sampleWithoutReplacement(models, num_options);
  var emotions_1 = jsPsych.randomization.sampleWithoutReplacement(emotions, num_options);

  console.log(models_1)
  console.log(emotions_1)

  //remove the initially selected models from set 1
  var models_2_sample_set = models.filter( function( el ) {
  return models_1.indexOf( el ) < 0;
} );

  console.log(models_2_sample_set)
  
  //select models for set 2
  var models_2 = jsPsych.randomization.sampleWithoutReplacement(models_2_sample_set, num_options);

  //select emotions for set 2 by removing already used emotions
  var emotions_2_select = emotions.filter( function( el ) {
  return emotions_1.indexOf( el ) < 0;
} );
  //shuffle emotions
  var emotions_2 = jsPsych.randomization.shuffle(emotions_2_select);

  console.log(emotions_2)
  console.log(models_2)

  //create reward matrix
  reward_matrix_1 = {};
  reward_matrix_2 = {};
  console.log(structure_condition);
  console.log(match_condition);

  if (structure_condition == "model") {
    reward_vector_1 = models_1 
    if (match_condition=="match") {
      reward_vector_2 = models_2
    } else if (match_condition=="mismatch") {
      reward_vector_2 = emotions_2
    }
  } else if (structure_condition == "emotion") {
    reward_vector_1 = emotions_1 
    if (match_condition=="match") {
      reward_vector_2 = emotions_2
    } else if (match_condition=="mismatch") {
      reward_vector_2 = models_2
    }
  }

  for (k=0; k<reward_vector_1.length; k++) {
    cur_reward_key = reward_vector_1[k];
    cur_reward_index = reward_index_1[k];
    cur_reward = rewards[cur_reward_index];
    reward_matrix_1[cur_reward_key] = {"reward": cur_reward}
  }

  for (l=0; l<reward_vector_2.length; l++) {
    cur_reward_key = reward_vector_2[l];
    cur_reward_index = reward_index_2[l];
    cur_reward = rewards[cur_reward_index];
    reward_matrix_2[cur_reward_key] = {"reward": cur_reward}
  }

  console.log(reward_matrix_1);
  console.log(reward_matrix_2);

//put together images
var img_ext = ".jpg";
var img_sep = "_";
var all_images_1 = []
for (i=0; i<emotions_1.length; i++) {
  for (j=0; j<models_1.length; j++) {
    all_images_1.push("stimuli/"+models_1[j]+img_sep+emotions_1[i]+img_ext)
  }
}

var all_images_2 = []
for (i=0; i<emotions_2.length; i++) {
  for (j=0; j<models_2.length; j++) {
    all_images_2.push("stimuli/"+models_2[j]+img_sep+emotions_2[i]+img_ext)
  }
}

console.log(all_images_1);
console.log(all_images_2);

var all_images = all_images_1.concat(all_images_2);
var catch_images =  [
	"stimuli/sheep.jpg",
	"stimuli/hammer.jpg",
	"stimuli/basketball.jpg",
	"stimuli/horse.jpg",
	"stimuli/chair.jpg",
	"stimuli/zebra.jpg",
	"stimuli/giraffe.jpg",
	"stimuli/banana.jpg"];


// CREATE ALL UNIQUE EMOTION/ MODEL COMBINATIONS

var all_unique_trial_combinations_1 = [];
var all_unique_trial_combinations_2 = [];

//create all reorderings of model
var model_1_combinations =permutations(models_1);
console.log(model_1_combinations)
var model_2_combinations = permutations(models_2);
console.log(model_2_combinations)

//combine unique model combination orders with (static) emotion array to create
//all possible unordered combinations of models and emotions, 
//such that each model and emotion occurs uniquely within each array/ trial
//also store relevant reward information
for (i=0; i<model_1_combinations.length; i++) {
  current_models = model_1_combinations[i];
  current_combos=[];
  for (j=0; j<current_models.length; j++) {
    current_model = current_models[j];
    current_emotion = emotions_1[j];
    if (structure_condition == "emotion") {
      current_reward_key = current_emotion
    } else if (structure_condition == "model") {
      current_reward_key = current_model
    }

    //add noise to the reward (potentially)
    current_reward_adjusted = compute_reward(
      reward_matrix_1[current_reward_key]["reward"],
      noise_type,
      reward_adj_factor,
      reward_adj_shift)

    console.log(current_reward_adjusted)

    current_stimulus = {
      "stimulus_id": current_model+img_sep+current_emotion,
      "emotion": current_emotion,
      "model": current_model,
      "image": "stimuli/"+current_model+img_sep+current_emotion+img_ext,
      "reward_unadjusted": reward_matrix_1[current_reward_key]["reward"],
      "reward": current_reward_adjusted,
      "reward_score": current_reward_adjusted*reward_depiction_factor,
      "reward_image": "stimuli/stars_"+String(current_reward_adjusted)+".png",
    }

    current_combos.push(current_stimulus);
  }
  all_unique_trial_combinations_1.push(current_combos);
}

for (i=0; i<model_2_combinations.length; i++) {
  current_models = model_2_combinations[i];
  current_combos=[];
  for (j=0; j<current_models.length; j++) {
    current_model = current_models[j];
    current_emotion = emotions_2[j];
    if (structure_condition == "emotion") {
      if (match_condition=="match") {
        current_reward_key = current_emotion
      } else if (match_condition=="mismatch") {
        current_reward_key = current_model
      }
    } else if (structure_condition == "model") {
      if (match_condition=="match") {
        current_reward_key = current_model
      } else if (match_condition=="mismatch") {
        current_reward_key = current_emotion
      }
    }

    console.log(reward_matrix_2);
    console.log(current_reward_key);

    current_reward_adjusted = compute_reward(
      reward_matrix_2[current_reward_key]["reward"],
      noise_type,
      reward_adj_factor,
      reward_adj_shift)

    current_stimulus = {
      "stimulus_id": current_model+img_sep+current_emotion,
      "emotion": current_emotion,
      "model": current_model,
      "image": "stimuli/"+current_model+img_sep+current_emotion+img_ext,
      "reward_unadjusted": reward_matrix_2[current_reward_key]["reward"],
      "reward": current_reward_adjusted,
      "reward_score": current_reward_adjusted*reward_depiction_factor,
      "reward_image": "stimuli/stars_"+String(current_reward_adjusted)+".png",
    }

    current_combos.push(current_stimulus);
  }
  all_unique_trial_combinations_2.push(current_combos);
}

console.log(all_unique_trial_combinations_1);
console.log(all_unique_trial_combinations_2);

// construct all trials
var num_blocks = 2; // one block is currently 24 trials, so 2 blocks is 48 trials
var all_trials_1 = [];
var all_trials_2 = [];
var catch_trial_break = 47; // when to show the second round of catch trials
// put all trials together for each round based on the number of blocks
for (i=0; i<num_blocks; i++) {
  //shuffle block
  var block_trials_shuffled_1=jsPsych.randomization.shuffle(all_unique_trial_combinations_1);
  var block_trials_shuffled_2=jsPsych.randomization.shuffle(all_unique_trial_combinations_2);

  console.log(block_trials_shuffled_1);
  console.log(block_trials_shuffled_2);


  //add to trial list
  all_trials_1 = all_trials_1.concat(block_trials_shuffled_1);
  all_trials_2 = all_trials_2.concat(block_trials_shuffled_2);
  console.log(all_trials_1);
  console.log(all_trials_2)
}


//combine into full trial list
var all_trials = all_trials_1.concat(all_trials_2);

// create general parameters that will update dynamically
var cur_score = 0
var trial_counter = 1

// function for constructing a trial
function construct_trial(cur_trial) {
  //randomize position
  current_trial_shuffled = jsPsych.randomization.shuffle(cur_trial);

  console.log(current_trial_shuffled);

  //get stimulus property arrays
  trial_stimuli = [];
  trial_emotions = [];
  trial_models = [];
  trial_rewards = [];
  trial_rewards_unadjusted = [];
  trial_reward_scores = [];
  trial_reward_images = [];
  for (j=0; j<current_trial_shuffled.length; j++) {
    cur_trial_stimulus = current_trial_shuffled[j];
    trial_stimuli.push(cur_trial_stimulus["image"]);
    trial_emotions.push(cur_trial_stimulus["emotion"]);
    trial_models.push(cur_trial_stimulus["model"]);
    trial_rewards.push(cur_trial_stimulus["reward"]);
    trial_rewards_unadjusted.push(cur_trial_stimulus["reward_unadjusted"]);
    trial_reward_scores.push(cur_trial_stimulus["reward_score"]);
    trial_reward_images.push(cur_trial_stimulus["reward_image"]);
  }


    var trial = {
      type: 'explore-choice',
      instruction: "Click on the image that will give you the most stars.",
    stimuli: trial_stimuli,
    reward_scores: trial_reward_scores,
    reward_images: trial_reward_images,
    data: {
      "emotions": trial_emotions,
      "models": trial_models,
      "rewards": trial_rewards,
      "rewards_unadjusted": trial_rewards_unadjusted

    },
    on_start: function(trial) {
      if (trial_counter > 1) {
        trial.cur_score = cur_score;
        console.log(cur_score);
      }
      trial_counter++;  
    },
    on_finish: function(data) {
      cur_score = data.score_after_trial
    }
    };
  
    var show_reward = {
      type: 'show-reward',
      instruction: "",
      // function() {
      //   cur_reward = jsPsych.data.get().last(1).values()[0].reward;
      //   instruction = "You got " + cur_reward + " stars!";
      //   return instruction
      // },
      stimulus: function() {
        console.log(jsPsych.data.get().last(1).values());
        return jsPsych.data.get().last(1).values()[0].choiceImage
      },
      reward_image: function() {
        return jsPsych.data.get().last(1).values()[0].reward_image
      },
      cur_reward: function() {
        return trial_rewards[jsPsych.data.get().last(1).values()[0].reward_index]
      },
      cur_score: function() {
        return jsPsych.data.get().last(1).values()[0].score_after_trial
      },
      trial_duration: 2000
    
    }
    timeline.push(trial);
    timeline.push(show_reward);
}

//preload 
var preload_images = all_images.concat(catch_images);
console.log(preload_images);

var preload = {
    type: 'preload',
    auto_preload: true,
    images: preload_images
  }
  timeline.push(preload);

// add instructions
  var instructions_1 = {
    type: 'instructions',
    pages: ["<p>Welcome to the game!</p><p>First, we'll check you are able to see all of the images correctly. On the next two trials, click on the image that matches the word in the instructions.</p>",],
    show_clickable_nav: true
  }

  timeline.push(instructions_1);
  
  //add catch trials
  var catch_trial_1 = {
    type: 'explore-choice',
    instruction: "Click on the horse.",
  stimuli: ["stimuli/sheep.jpg","stimuli/hammer.jpg","stimuli/basketball.jpg","stimuli/horse.jpg"]
  }
  
  timeline.push(catch_trial_1);
  
  var catch_trial_2 = {
    type: 'explore-choice',
    instruction: "Click on the hammer.",
  stimuli: ["stimuli/hammer.jpg","stimuli/basketball.jpg","stimuli/horse.jpg","stimuli/sheep.jpg"]
  }
  
  timeline.push(catch_trial_2);

  // add instructions
  var instructions_2 = {
    type: 'instructions',
    pages: ["<p>Great job! Now we'll begin the main game.</p><p> In this game, you will have the chance to earn rewards by collecting stars. <b>Your goal is to collect as many stars as possible.</b> You can collect stars by clicking on images of faces. After you click on an image, you will see how many stars you collected.</p><p>Do your best to collect as many stars as you can! <b>The top 50 participants who collect the most stars will receive a $X.XX bonus.</b></p><p>The game will take approximately XX minutes. Click next to begin.</p>"],
    show_clickable_nav: true
  }

  timeline.push(instructions_2);
  
//construct full experimental timeline
  
for (i=0; i<all_trials.length; i++) {

  current_trial = all_trials[i];
  console.log(current_trial);
  construct_trial(current_trial);
  

  // //add an extra set of catch trials between blocks 1 and 2 (currently commented out)
	//   if (i==catch_trial_break) {
    // add instructions
  // var instructions_3 = {
  //   type: 'instructions',
  //   pages: ["<p>Great job!</p><p>Next, we'll check again that you are able to see all of the images correctly. On the next two trials, click on the image that matches the word in the instructions.</p>",],
  //   show_clickable_nav: true
  // }

  // timeline.push(instructions_3);
	//   //add catch trials
	//   var catch_trial_3 = {
	//     type: 'explore-choice',
	//     instruction: "Click on the banana.",
	// 	  stimuli:
	// ["stimuli/chair.jpg",
	// "stimuli/zebra.jpg",
	// "stimuli/giraffe.jpg",
	// "stimuli/banana.jpg"]
	//   }
	//
	//   timeline.push(catch_trial_3);
	//
	//   var catch_trial_4 = {
	//     type: 'explore-choice',
	//     instruction: "Click on the giraffe.",
	//   stimuli: ["stimuli/chair.jpg",
	// 	  "stimuli/banana.jpg",
	// 	  "stimuli/giraffe.jpg",
	// 	  "stimuli/zebra.jpg"]
	//   }
	//
	//   timeline.push(catch_trial_4);
	//   }
};

var experiment_end = {
    type: 'instructions',
    pages: function() {
      final_score = Math.floor((jsPsych.data.get().last(1).values()[0].score_after_trial-1) / reward_depiction_factor);
      return ['<p>Thank you for playing the game! You collected ' + String(final_score) + ' stars!</p><p>If you finish in the top 50 participants overall, you will receive a $X.XX bonus in addition to your compensation for completing the task.</p><p>Now we have a few brief questions. Click next to begin.</p>']
    },
    show_clickable_nav: true
  }

  timeline.push(experiment_end);

  //emotion questions
  var images_to_rate = all_images;
  var emotion_question_timeline = [];
  for (i=0; i<images_to_rate.length; i++) {
    emotion_question_timeline.push({'pic': images_to_rate[i]})
};

emotion_question_timeline_shuffled = jsPsych.randomization.shuffle(emotion_question_timeline)

console.log(emotion_question_timeline_shuffled)

for (i=0; i<emotion_question_timeline_shuffled.length; i++) {
  current_emotion_question = emotion_question_timeline_shuffled[i];
  console.log(current_emotion_question)
  var prompt_text = '<img src="'+current_emotion_question['pic']+'" style="width: 300px;"><p>What emotion is this person expressing?</p>'
  emotion_question_1 = {
    type: 'survey-text',
    questions: [
    {prompt: prompt_text}
    ]
    
  }
  //timeline.push(emotion_question_1);
  emotion_question_2 = {
      type: 'html-slider-response',
      prompt: '<p>Rate the intensity of the emotion.</p>',
      stimulus: '<img src="'+current_emotion_question['pic']+'" style="width: 300px;">',
      min: 0,
      max: 100,
      slider_start: 50,
      labels: ["not at all intense","extremely intense"]
    }
  //timeline.push(emotion_question_2);
}

  //demographics

var demo_1 = {
    type: 'survey-text',
    preamble: "Next, we have just a few demographic questions.",
    timeline: [
    {questions: [{prompt: "Please enter your age (in number of years; e.g., 30).",name: "age"}]},
    {questions: [{prompt: "What is your gender?",name: "gender"}]},
    {questions: [{prompt: "What country do you currently live in? (e.g., United States)", name: "country"}]},
    {questions: [{prompt: "What is your first/ primary language(s)?", name: "language"},{prompt: "Please list any other languages you are fluent in.", name: "other_languages"}]},

    ]
  }
  timeline.push(demo_1);

  var demo_2 = {
  type: 'survey-multi-select',
  preamble: "Next, we have just a few demographic questions.",
  questions: [
    {
      prompt: "What is your race or ethnicity? Please check one or more boxes.", 
      options: ["Black or African American", "Hispanic or Latino", "American Indian or Alaska Native", "Asian", "Native Hawaiian or Other Pacific Islander","Other","Prefer not to answer"], 
      horizontal: false,
      required: false,
      name: 'race'
    }
    ]
  }
  timeline.push(demo_2);

  var demo_3 = {
  type: 'survey-multi-choice',

  questions: [
    {
      prompt: "What is your current level of education?", 
      options: ["Some high school", "High school", "Some college/ university", "Bachelor's degree", "Master's degree","Doctoral degree","Other professional degree","Not applicable/ unknown","Other","Prefer not to answer"], 
      horizontal: false,
      required: false,
      name: 'education'
    }
    ]
    } 
  timeline.push(demo_3);
 
  //game questions
  var debrief_questions = {
    type: 'survey-text',
    questions: [
    {prompt: "Did you notice any patterns in the game? If yes, please exlain.",name: "patterns", rows: 3,columns: 60},
    {prompt: "Did you use a strategy to win stars in the game? If yes, please exlain.",name: "strategy", rows: 3,columns: 60},
    {prompt: "Any additional comments?", name: "comments", rows: 3,columns: 60}
    ],

  }

timeline.push(debrief_questions);

//debrief and code message
var experimentFinal = [];
var final_instructions = {
  type: 'instructions',
  size: 400,
  pages: [
    'Congratulations, you are all done! Thanks for participating! In this experiment, we are interested in how people learn to associate different people and emotional cues with rewards. Please let us know if you have any questions!'
        +"<br>" + "<br>"
        +'<center>Your survey completion code for <u>Prolific</u> is</center>'
        +"<br>"
        +'<center><b style="font-size:20px">'+ prolific_code +'</b></center>'
        +"<br>"
        +'<center>Please make sure you save this somewhere safe. You will need to enter this code into Prolific to be paid.</center>'
        ],
  show_clickable_nav: false
};

//add instructions trial to experiment
experimentFinal.push(final_instructions);
 

  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
      //jsPsych.data.displayData();
      jsPsych.init({
        timeline: experimentFinal
      });
    }
  });
</script>

</html>
