<!DOCTYPE html>
<html>

<head>

  <script src="jsPsych-6.3.1/examples/js/snap.svg-min.js"></script>
  <script src="jsPsych-6.3.1/jspsych.js"></script>
  <script src="jspsych-explore-choice.js"></script>
  <script src="jspsych-show-reward.js"></script>
  <script src="jsPsych-6.3.1/plugins/jspsych-preload.js"></script>
  <link rel="stylesheet" href="jsPsych-6.3.1/css/jspsych.css">
</head>
<body></body>
<script>

  //define permutation functions
  const rotations = ([l, ...ls], rs = []) => 
  l == undefined ? [] : [[l, ...ls, ...rs], ... rotations (ls, [...rs, l])]

const permutations = ([l, ...ls]) =>
  l == undefined ? [[]] : [...permutations (ls) .flatMap (p => rotations ([l, ...p])) ]



  var timeline=[]

  var preload = {
    type: 'preload',
    auto_preload: true
  }
  timeline.push(preload)


  var structure_conditions = ["emotion","model"];
  var match_conditions = ["match","mismatch"];

  var models = ["AF02", "AF09", "AF10", "AF11","AM03","AM04","AM05","AM06","BF04","BF05","BF06","BF08","BM03", "BM04", "BM07", "BM16","HF02", "HF04", "HF09", "HF10","HM02", "HM07", "HM09", "HM10","WF04", "WF06", "WF11", "WF14","WM07", "WM09", "WM11", "WM13"];
  var emotions = ["AO","CC","DO","FO","HE","HO","SC","SUR"];

  var num_options = 4

  var models_1 = jsPsych.randomization.sampleWithoutReplacement(models, num_options);
  var emotions_1 = jsPsych.randomization.sampleWithoutReplacement(emotions, num_options);

  console.log(models_1)
  console.log(emotions_1)

  //remove the initially selected models from set 1
  var models_2_sample_set = models.filter( function( el ) {
  return models_1.indexOf( el ) < 0;
} );

  console.log(models_2_sample_set)
  
  //select models for set 2
  var models_2 = jsPsych.randomization.sampleWithoutReplacement(models_2_sample_set, num_options);

  //select emotions for set 2 by removing already used emotions
  var emotions_2 = emotions.filter( function( el ) {
  return emotions_1.indexOf( el ) < 0;
} );

  console.log(emotions_2)
  console.log(models_2)

//put together images
var img_ext = ".jpg";
var img_sep = "_";
var all_images_1 = []
for (i=0; i<emotions_1.length; i++) {
  for (j=0; j<models_1.length; j++) {
    all_images_1.push("stimuli/"+models_1[j]+img_sep+emotions_1[i]+img_ext)
  }
}

var all_images_2 = []
for (i=0; i<emotions_2.length; i++) {
  for (j=0; j<models_2.length; j++) {
    all_images_2.push("stimuli/"+models_2[j]+img_sep+emotions_2[i]+img_ext)
  }
}

console.log(all_images_1);
console.log(all_images_2);

// CREATE ALL UNIQUE EMOTION/ MODEL COMBINATIONS

var all_unique_trial_combinations_1 = [];
var all_unique_trial_combinations_2 = [];

//create all reorderings of model
var model_1_combinations =permutations(models_1);
console.log(model_1_combinations)
var model_2_combinations = permutations(models_2);
console.log(model_2_combinations)

//combine unique model combination orders with (static) emotion array to create
//all possible unordered combinations of models and emotions, 
//such that each model and emotion occurs uniquely within each array/ trial
for (i=0; i<model_1_combinations.length; i++) {
  current_models = model_1_combinations[i];
  current_combos=[];
  for (j=0; j<current_models.length; j++) {
    current_combos.push("stimuli/"+current_models[j]+img_sep+emotions_1[j]+img_ext)
  }
  all_unique_trial_combinations_1.push(current_combos);
}

for (i=0; i<model_2_combinations.length; i++) {
  current_models = model_2_combinations[i];
  current_combos=[];
  for (j=0; j<current_models.length; j++) {
    current_combos.push("stimuli/"+current_models[j]+img_sep+emotions_2[j]+img_ext)
  }
  all_unique_trial_combinations_2.push(current_combos);
}

console.log(all_unique_trial_combinations_1);
console.log(all_unique_trial_combinations_2);


var trial_number = 32;
  
var rewards = [8,16,32,64];
var reward_images = ["stimuli/stars_2.png","stimuli/stars_4.png","stimuli/stars_6.png","stimuli/stars_8.png"]

// create vsl block for jspsych
var cur_score = 0
var trial_counter = 1
  
  
for (i=0; i<10; i++) {

  current_trial = all_unique_trial_combinations_1[i];
  //randomize position
  current_trial_shuffled = jsPsych.randomization.shuffle(current_trial);

  console.log(current_trial_shuffled);

	  var trial = {
	    type: 'explore-choice',
      instruction: "Click on the image that will give you the most stars.",
		stimuli: current_trial_shuffled,
		on_start: function(trial) {
			if (trial_counter > 1) {
				trial.cur_score = cur_score;
				console.log(cur_score);
			}
			trial_counter++;	
		},
		on_finish: function(data) {
			cur_score = data.score_after_trial
		}
	  };
  
	  var show_reward = {
		  type: 'show-reward',
      instruction: "",
      // function() {
      //   cur_reward = jsPsych.data.get().last(1).values()[0].reward;
      //   instruction = "You got " + cur_reward + " stars!";
      //   return instruction
      // },
		  stimulus: function() {
			  console.log(jsPsych.data.get().last(1).values());
			  return jsPsych.data.get().last(1).values()[0].choiceImage
		  },
		  reward_image: function() {
		  	return reward_images[jsPsych.data.get().last(1).values()[0].reward_index]
		  },
		  cur_reward: function() {
		  	return reward_images[jsPsych.data.get().last(1).values()[0].reward]
		  },
		  cur_score: function() {
		  	return jsPsych.data.get().last(1).values()[0].score_after_trial
		  },
		  trial_duration: 2000
	  
	  }
	  timeline.push(trial);
	  timeline.push(show_reward);
  };
 

  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
</script>

</html>
